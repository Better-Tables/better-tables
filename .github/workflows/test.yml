name: Test Suite

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'packages/core/**'
      - 'packages/adapters/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'turbo.json'
      - '.github/workflows/test.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'packages/core/**'
      - 'packages/adapters/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'turbo.json'
      - '.github/workflows/test.yml'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.19.0'

jobs:
  test-core:
    name: Test Core Package
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/core

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          echo "Installing dependencies from workspace root..."
          cd ../..
          pnpm install --frozen-lockfile
          echo ""
          echo "‚úì Dependencies installed successfully"
          echo "Workspace packages:"
          pnpm list --depth=0 2>/dev/null | head -20 || echo "Package list command not available"

      - name: Run Core Tests
        run: |
          echo "========================================="
          echo "üß™ Running Core Package Tests"
          echo "========================================="
          echo ""
          echo "Working directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "pnpm version: $(pnpm --version)"
          echo ""
          echo "Starting test execution..."
          echo ""
          echo "Running: pnpm test -- --run --reporter=verbose"
          echo ""
          pnpm test -- --run --reporter=verbose
          echo ""
          echo "========================================="
          echo "‚úÖ Core tests completed successfully"
          echo "========================================="

  test-adapters:
    name: Test Adapter Packages
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/adapters/drizzle
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: better_tables_test
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpassword
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -ptestpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          --health-start-period=30s
      
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: drizzle_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U testuser"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          echo "Installing dependencies from workspace root..."
          cd ../../..
          pnpm install --frozen-lockfile
          echo ""
          echo "‚úì Dependencies installed successfully"
          echo "Workspace packages:"
          pnpm list --depth=0 2>/dev/null | head -20 || echo "Package list command not available"

      - name: Build Core Package (dependency)
        run: |
          echo "Building @better-tables/core package as dependency..."
          cd ../../..
          echo "Building core package..."
          cd packages/core
          pnpm build
          echo ""
          echo "Verifying core package was built..."
          ls -la dist/ || echo "Warning: dist directory not found"
          echo "‚úì Core package built successfully"

      - name: Run Adapter Tests
        env:
          # Disable SQLite tests in CI (better-sqlite3 requires native bindings)
          CI: 'true'
          DISABLE_SQLITE: 'true'
          # Set connection strings for MySQL and Postgres services
          # Using root for MySQL since tests need to create databases
          MYSQL_TEST_URL: mysql://root:testpassword@localhost:3306
          POSTGRES_TEST_URL: postgresql://testuser:testpassword@localhost:5432/drizzle_test
        run: |
          echo "========================================="
          echo "üß™ Running Adapter Package Tests"
          echo "========================================="
          echo ""
          echo "Working directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "pnpm version: $(pnpm --version)"
          echo ""
          echo "Database services available:"
          echo "  MySQL: $MYSQL_TEST_URL"
          echo "  Postgres: $POSTGRES_TEST_URL"
          echo ""
          echo "Note: SQLite tests are excluded from CI (DISABLE_SQLITE=true)"
          echo ""
          echo "Waiting for database services to be ready..."
          sleep 5
          echo ""
          echo "Starting test execution..."
          echo ""
          echo "Running: pnpm test --run --reporter=verbose"
          echo ""
          pnpm test -- --run --reporter=verbose
          echo ""
          echo "========================================="
          echo "‚úÖ Adapter tests completed successfully"
          echo "========================================="

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-core, test-adapters]
    if: always()

    steps:
      - name: Test Results Summary
        run: |
          echo "========================================="
          echo "üìä Test Execution Summary"
          echo "========================================="
          echo ""
          
          CORE_RESULT="${{ needs.test-core.result }}"
          ADAPTER_RESULT="${{ needs.test-adapters.result }}"
          
          if [ "$CORE_RESULT" = "success" ]; then
            echo "Core Package Tests: ‚úÖ PASSED"
          else
            echo "Core Package Tests: ‚ùå FAILED"
          fi
          
          if [ "$ADAPTER_RESULT" = "success" ]; then
            echo "Adapter Package Tests: ‚úÖ PASSED"
          else
            echo "Adapter Package Tests: ‚ùå FAILED"
          fi
          
          echo ""
          echo "========================================="
          
          if [ "$CORE_RESULT" != "success" ] || [ "$ADAPTER_RESULT" != "success" ]; then
            echo "‚ùå Some tests failed. Please check the logs above for details."
            exit 1
          else
            echo "‚úÖ All tests passed successfully!"
          fi
          echo "========================================="

